name: Deploy to Azure (Example)

# This workflow is disabled by default. Copy or rename this file to
# '.github/workflows/deploy-azure.yml' after providing all required secrets.

on:
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: medical-analyzer-rg
  AKS_CLUSTER_NAME: medical-analyzer-aks
  IMAGE_NAME: medical-analyzer

jobs:
  push-to-acr:
    name: Build and Push Docker image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_NAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push to ACR
        uses: docker/build-push-action@v5
        with:
          context: .
          dockerfile: Dockerfile.simple
          push: true
          tags: |
            ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
            ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    needs: push-to-acr

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure subscription
        run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Create namespace if missing
        run: kubectl create namespace medical-analyzer --dry-run=client -o yaml | kubectl apply -f -

      - name: Create ACR pull secret
        run: |
          ACR_PASSWORD=$(az acr credential show --name ${{ secrets.ACR_NAME }} --query "passwords[0].value" -o tsv)
          kubectl create secret docker-registry acr-secret \
            --docker-server=${{ secrets.ACR_NAME }}.azurecr.io \
            --docker-username=${{ secrets.ACR_NAME }} \
            --docker-password=$ACR_PASSWORD \
            --namespace=medical-analyzer \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy manifests
        run: |
          sed -i "s|<ACR_LOGIN_SERVER>|${{ secrets.ACR_NAME }}.azurecr.io|g" k8s/deployment.yaml
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml

      - name: Wait for rollout
        run: kubectl rollout status deployment/medical-analyzer -n medical-analyzer --timeout=5m

      - name: Show service endpoint
        run: |
          kubectl get service medical-analyzer-service -n medical-analyzer
          EXTERNAL_IP=$(kubectl get service medical-analyzer-service -n medical-analyzer -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -n "$EXTERNAL_IP" ]; then
            echo "Application available at http://$EXTERNAL_IP"
          else
            echo "External IP not allocated yet."
